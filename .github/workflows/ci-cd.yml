name: CI/CD Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Node linting tools
        run: |
          npm install -g eslint

      - name: Install Python linting tools
        run: |
          pip install flake8 black

      - name: Lint API Gateway
        run: |
          cd services/api-gateway
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            npx eslint . || echo "Linting warnings found"
          else
            echo "No ESLint config found, skipping"
          fi

      - name: Lint User Service
        run: |
          cd services/user-service
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            npx eslint . || echo "Linting warnings found"
          else
            echo "No ESLint config found, skipping"
          fi

      - name: Lint Email Service
        run: |
          cd services/email-service
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            npx eslint . || echo "Linting warnings found"
          else
            echo "No ESLint config found, skipping"
          fi

      - name: Lint Push Service
        run: |
          cd services/push-service
          echo "Checking Python code style..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Linting warnings found"

      - name: Lint Template Service
        run: |
          cd services/template-service
          echo "Checking Python code style..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Linting warnings found"

  build:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_USER=notif_user
          POSTGRES_PASSWORD=notif_password
          POSTGRES_DB=notification_system
          RABBITMQ_USER=guest
          RABBITMQ_PASSWORD=guest
          EOF

      - name: Build all services
        run: |
          echo "Building Docker images..."
          docker compose build

      - name: Verify images were created
        run: |
          echo "Verifying built images..."
          docker images | grep notif || echo "Warning: No images found with 'notif' prefix"
          docker images

      - name: Start services
        run: |
          echo "Starting all services..."
          docker compose up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be ready..."
          sleep 45

          echo "Service status:"
          docker compose ps

      - name: Check service health
        run: |
          echo "Checking service endpoints..."

          # Check if containers are running
          docker compose ps | grep "Up" || exit 1

          # Try to reach API Gateway
          curl -f http://localhost:3000/health || echo "API Gateway health check not implemented yet"

          # Try to reach other services
          curl -f http://localhost:3002/health || echo "User Service health check not implemented yet"
          curl -f http://localhost:3001/health || echo "Email Service health check not implemented yet"
          curl -f http://localhost:3003/health || echo "Push Service health check not implemented yet"
          curl -f http://localhost:3004/health || echo "Template Service health check not implemented yet"

      - name: Check RabbitMQ
        run: |
          echo "Checking RabbitMQ Management UI..."
          curl -u guest:guest http://localhost:15672/api/health/checks/alarms || echo "RabbitMQ management not accessible"

      - name: Show service logs
        if: failure()
        run: |
          echo "Showing logs for debugging..."
          docker compose logs

      - name: Stop services
        if: always()
        run: |
          echo "Stopping all services..."
          docker compose down -v

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deployment placeholder
        run: |
          echo "============================================"
          echo "DEPLOYMENT STAGE"
          echo "============================================"
          echo ""
          echo "All checks passed!"
          echo "Docker images built successfully"
          echo ""
          echo "Waiting for server details from bootcamp..."
          echo ""
          echo "Once you receive server access, uncomment the"
          echo "deployment method below that matches your setup."
          echo "============================================"
